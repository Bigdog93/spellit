# DevOps

`ì„œë²„ ì£¼ì†Œ` : j8d201.p.ssafy.io

`ip ì£¼ì†Œ` : 13.125.214.213



```bash

ğŸ’¡ DevOps ì§„í–‰ ê³¼ì • ê°„ë‹¨ ì„¤ëª…

- push ë  ë•Œë§ˆë‹¤ docker image ë²„ì „ ë³„ë¡œ ì‹¤ì‹œê°„ ì €ì¥

- ì´ ë²„ì „ì„ í†µí•´ ë¸”ë£¨ ê·¸ë¦° ë°°í¬ ë°©ë²•ì„ ì‚¬ìš©í•´ ë¬´ì¤‘ë‹¨ ë°°í¬í–ˆë‹¤

Â  Â  - ë¸”ë£¨ê°€ n-1ë²„ì „ì´ë©´ ê·¸ë¦°ì´ në²„ì „ìœ¼ë¡œ ì‹¤í–‰

Â  Â  - ê·¸ë¦°ì´ n-1ë²„ì „ì´ë©´ ë¸”ë£¨ê°€ në²„ì „ìœ¼ë¡œ ì‹¤í–‰

```


&nbsp;


# âœ 1. AWS

![ec2_ubuntu](https://user-images.githubusercontent.com/72541544/229697291-8afd691f-1ce5-4a46-97f0-6a58c5cd7024.png)


&nbsp;

**âœ” port**

| Â | port |
| --- | --- |
| frontend | 3000, 30001 |
| backend | 8000, 8001 |
| mysql | 3305 |
| flask (ê°ì •ìŒì„±ì¸ì‹) | 5000 |
| openvidu | 3478 |
| jenkins | 7777 |


&nbsp;


**âœ” AWS ì ‘ì†í•  ë•Œ, ip ì£¼ì†Œê°€ ì•Œê³  ì‹¶ë‹¤ë©´**
  

`curl [http://169.254.169.254/latest/meta-data/public-ipv4](http://169.254.169.254/latest/meta-data/public-ipv4)` : í˜„ì¬ ip ì£¼ì†Œ í™•ì¸í•˜ê¸°


&nbsp;


### ğŸ“– A. ubuntuì—ì„œ ë°©í™”ë²½ ì„¤ì •(UFW)


> **ğŸ’¡ ì°¸ê³ **
> `Ubuntu`ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” ë˜ì–´ ìˆì–´ ufw enableë¥¼ ì‚¬ìš©í•˜ì—¬ ufwë¥¼ í™œì„±í™”í•œë‹¤.
> `ufw`ë¥¼ í™œì„±í™”í•˜ë©´ ë°©í™”ë²½ì´ ì‘ë™í•˜ê¸° ë•Œë¬¸ì— ëª¨ë“  í¬íŠ¸ê°€ ìë™ìœ¼ë¡œ ë§‰íˆê²Œ ëœë‹¤.
> `UFW` : Ubuntu Firewall (Ubuntuì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ë°©í™”ë²½)


&nbsp;



**âœ” ufw ìƒíƒœ í™•ì¸í•˜ê¸°**

  

```bash

$ sudo ufw status

```

&nbsp;


**âœ” ufwë¥¼ í™œì„±í™” ì‹œí‚¤ê¸°**

  

```bash

# ì²˜ìŒì€ inactive ìƒíƒœì´ê¸° ë•Œë¬¸ì— ì•„ë˜ ìˆœì„œì™€ ê°™ì´ ëª…ë ¹ì–´ ì…ë ¥

$ sudo ufw allow 22

$ sudo ufw enable

```

- ufw enable : ufwë¥¼ í™œì„±í™” (ufwë¥¼ í™œì„±í™”í• ì‹œ ë°©í™”ë²½ì´ ì‘ë™, ëª¨ë“  í¬íŠ¸ê°€ ìë™ìœ¼ë¡œ ë§‰íŒë‹¤.)

- ë°©í™”ë²½ ì„¤ì •ì„ í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì¢…ë£Œì‹œ, ë‹¤ìŒì— ssh ì ‘ê·¼ì„ ëª»í•  ìˆ˜ë„ ìˆë‹¤.

&nbsp;


**âœ” ubuntuì—ì„œ ë°©í™”ë²½ ë°©ì¹¨ ë° ë¡œê·¸ë¥¼ ë‚¨ê¸°ê¸°**


```bash

$ ufw defalut deny/allow

```

- ë°©í™”ë²½ ë°©ì¹¨ì„ ì…ë ¥


&nbsp;


```bash

$ ufw logging on

```


- ë¡œê·¸ë¥¼ ë‚¨ê¸°ë„ë¡ ë³€ê²½

  ![logging](https://user-images.githubusercontent.com/72541544/229697281-24e70381-ccde-4e03-99f7-1a71a7e7d631.png)

&nbsp;


**âœ” ubuntuì—ì„œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ ì—´ê¸°**

```bash

$ ufw allow <port>/<optional: protocol>

```


ex)

```bash

$ ufw allow 7777

```


&nbsp;

**âœ” ubuntuì—ì„œ í™œì„±í™” ì—¬ë¶€ ì²´í¬**

  ```bash

$ ufw status

$ ufw status numbered

```

- ufw status : í™œì„±í™” ì—¬ë¶€ ì²´í¬

&nbsp;

![ufw](https://user-images.githubusercontent.com/72541544/229697283-14a3534d-661d-43a2-8ae8-7e0302b09701.png)
  

```bash

$ sudo ufw allow from 52.33.44.444

```

- íŠ¹ì • ipì—ì„œ ëª¨ë“  í¬íŠ¸ ì ‘ê·¼ì„ í—ˆìš©í•  ë•Œ ì´ì™€ ê°™ì´ ì‚¬ìš©

ì°¸ê³  : [https://kugancity.tistory.com/entry/ubuntuì—ì„œ-ë°©í™”ë²½-ì„¤ì •-UFW](https://kugancity.tistory.com/entry/ubuntu%EC%97%90%EC%84%9C-%EB%B0%A9%ED%99%94%EB%B2%BD-%EC%84%A4%EC%A0%95-UFW)


&nbsp;



**âœ” ìœ„ì™€ ê°™ì´ ì„¤ì •í•œ portë¥¼ ì‚­ì œí•˜ê³  ì‹¶ì„ ë•Œ**

```bash

$ ufw delete rule_number

```

&nbsp;



**âœ” ufc ì¢…ë£Œ ì‹œí‚¤ê¸°**

```bash

$ sudo ufw disable

```


&nbsp;

&nbsp;




# âœ 2. Docker

  

**âœ” docker hub id, pwd**


```

id : d201ssafy

pwd : d201ssafy

```


&nbsp;

âœ” `docker-compose.yml`

```yaml

version: "3"

services:

Â  jenkins:

Â  Â  image: jenkins/jenkins:lts

Â  Â  container_name: j8d201_jenkins

Â  Â  user: root

Â  Â  volumes:

Â  Â  Â  - /home/ubuntu/jenkins:/var/jenkins_home

Â  Â  Â  - /var/run/docker.sock:/var/run/docker.sock

Â  Â  ports:

Â  Â  Â  - 7777:8080

Â  db:

Â  Â  image: mysql:8.0

Â  Â  restart: always

Â  Â  environment:

Â  Â  Â  MYSQL_ROOT_PASSWORD: ssafy

Â  Â  Â  TZ: Asiz/Seoul

Â  Â  container_name: j8d201_mysql

Â  Â  volumes:

Â  Â  Â  - /home/ubuntu/db:/var/lib/mysql

Â  Â  ports:

Â  Â  Â  - 3305:3306

```


&nbsp;

&nbsp;


# âœ 3. Jenkins

  

### ğŸ“– 1. backend pipeline(Jenkins)

  

```groovy

pipeline {

Â  Â  agent any

  

Â  Â  environment{

Â  Â  Â  Â  imagebename = "d201ssafy/d201_be"

Â  Â  Â  Â  registryCredential = "DockerHub_IdPwd"

Â  Â  Â  Â  dockerImage = ""

Â  Â  Â  Â  dockerImageLatest = ""

Â  Â  }

Â  Â  stages {

Â  Â  Â  Â  stage('GitLab Clone') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  checkout scmGit(branches: [[name: '*/be']], extensions: [submodule(parentCredentials: true, reference: '', trackingSubmodules: true)], userRemoteConfigs: [[credentialsId: 'D201GitLab_IdPwd', url: 'https://lab.ssafy.com/s08-ai-speech-sub2/S08P22D201']])

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Backend-Build') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  dir('spellit') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh '''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chmod +x gradlew

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ./gradlew clean bootJar

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker before pull image stop'){

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  sshagent(credentials: ['EC2GumiD201']) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "ì‹œì‘"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh '''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if test "`docker ps -aq --filter ancestor=d201ssafy/d201_be:latest`"; then

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker stop $(docker ps -aq --filter ancestor=d201ssafy/d201_be:latest)"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker rm -f $(docker ps -aq --filter ancestor=d201ssafy/d201_be:latest)"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker rmi d201ssafy/d201_be:latest"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker-Build (backend)') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  dir('spellit'){

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ê°œì¸ì ìœ¼ë¡œ jenkins containerì— ì ‘ì†í•´, docker ì„¤ì¹˜(ê´€ë ¨ ëª…ë ¹ì–´ëŠ” ë¸”ë¡œê·¸ ì°¸ê³ )

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // https://kanoos-stu.tistory.com/m/53

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // tagë¥¼ ë¶™ì—¬ ë²„ì „ ë³„ë¡œ ë‚˜ëˆˆë‹¤.

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImage = docker.build imagebename + ":$BUILD_NUMBER"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImageLatest = docker.build imagebename + ":latest"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker-Push (backend)') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  echo 'Push Docker and delete image'

Â  Â  Â  Â  Â  Â  Â  Â  script {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  docker.withRegistry('', registryCredential){

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImage.push()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImageLatest.push()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker new image remove') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  // docker hubì— push ë˜ì—ˆê¸°ì— ì‚­ì œí•œë‹¤.

Â  Â  Â  Â  Â  Â  Â  Â  sh "docker rmi $imagebename:$BUILD_NUMBER"

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('SSH-EC2(docker image float') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  sshagent(credentials: ['EC2GumiD201']) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "echo Hello"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io 'sudo docker pull $imagebename:latest'"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io 'sudo docker run -i -p 8080:8080 $imagebename:latest'"

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

Â  Â  post {

Â  Â  Â  Â  always {

Â  Â  Â  Â  Â  Â  echo "í•­ìƒ ì‹¤í–‰"

Â  Â  Â  Â  }

Â  Â  Â  Â  success {

Â  Â  Â  Â  Â  Â  echo "ì„±ê³µ"

Â  Â  Â  Â  }

Â  Â  Â  Â  failure {

Â  Â  Â  Â  Â  Â  echo "ì‹¤íŒ¨í–ˆì„ ê²½ìš°, í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹¤í–‰ë˜ê²Œ êµ¬í˜„í•  ì˜ˆì •"

Â  Â  Â  Â  }

Â  Â  }

}

```



&nbsp;

### ğŸ“– 2. frontend pipeline(Jenkins)

  

> **ğŸ’¡ ì°¸ê³ **
> 
> ì²« ë²ˆì§¸ : nginx ì ìš©í•˜ì§€ ì•Šì•˜ì„ ë•Œ
> ë‘ ë²ˆì§¸ : nginx ì ìš©í–ˆì„ ë•Œ
> ë‘ ê°œì˜ ì°¨ì´ì ì€ : dockerfileì—ì„œ nginx ê´€ë ¨ ì„¤ì • ì°¨ì´ì ì´ ìˆë‹¤.


&nbsp;


  

### **âœ 2-1 nginx ì ìš©í•˜ì§€ ì•Šì•˜ì„ ë•Œ, jenkins pipeline**

  

```groovy

pipeline {

Â  Â  agent any

Â  Â  // node pluginìœ¼ë¡œ ì„¤ì¹˜ í›„, ì„¤ì •ì—ì„œ ë²„ì „ ë§ì¶°ì¤€ ê²ƒì„ ì“´ë‹¤.

Â  Â  tools {nodejs "Node16_14_2"}

  

Â  Â  environment{

Â  Â  Â  Â  imagefename = "d201ssafy/d201_fe"

Â  Â  Â  Â  registryCredential = "DockerHub_IdPwd"

Â  Â  Â  Â  dockerImage = ""

Â  Â  Â  Â  dockerImageLatest = ""

Â  Â  }

Â  Â  stages {

Â  Â  Â  Â  stage('GitLab Clone') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  checkout scmGit(branches: [[name: '*/fe']], extensions: [submodule(parentCredentials: true, reference: '', trackingSubmodules: true)], userRemoteConfigs: [[credentialsId: 'D201GitLab_IdPwd', url: 'https://lab.ssafy.com/s08-ai-speech-sub2/S08P22D201']])

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Frontend-Build') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  dir('spellit') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "ls -al"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // node, npm ì²« ì„¤ì¹˜í•  ë•Œ

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh """

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if ! test npm;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  then

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "ì„¤ì¹˜"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  curl -sL https://deb.nodesource.com/setup_16.x -o /tmp/nodesource_setup.sh

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bash /tmp/nodesource_setup.sh

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  apt install nodejs

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  apt install npm

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "ì„¤ì¹˜ ë˜ì–´ ìˆë‹¤."

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fi

  

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  npm i

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  CI=false npm run build

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  """

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CI ë¸”ë¡œê·¸ : https://merrily-code.tistory.com/123

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker before pull image stop'){

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  sshagent(credentials: ['EC2GumiD201']) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "ì‹œì‘"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh '''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if test "`docker ps -aq --filter ancestor=d201ssafy/d201_fe:latest`"; then

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker stop $(docker ps -aq --filter ancestor=d201ssafy/d201_fe:latest)"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker rm -f $(docker ps -aq --filter ancestor=d201ssafy/d201_fe:latest)"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker rmi d201ssafy/d201_fe:latest"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker-Build (frontend)') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  dir('spellit'){

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ê°œì¸ì ìœ¼ë¡œ jenkins containerì— ì ‘ì†í•´, docker ì„¤ì¹˜(ê´€ë ¨ ëª…ë ¹ì–´ëŠ” ë¸”ë¡œê·¸ ì°¸ê³ )

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // https://kanoos-stu.tistory.com/m/53

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // tagë¥¼ ë¶™ì—¬ ë²„ì „ ë³„ë¡œ ë‚˜ëˆˆë‹¤.

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImage = docker.build imagefename + ":$BUILD_NUMBER"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImageLatest = docker.build imagefename + ":latest"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker-Push (frontend)') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  script {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  docker.withRegistry('', registryCredential){

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImage.push()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImageLatest.push()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker new image remove') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  // docker hubì— push ë˜ì—ˆê¸°ì— ì‚­ì œí•œë‹¤.

Â  Â  Â  Â  Â  Â  Â  Â  sh "docker rmi $imagefename:$BUILD_NUMBER"

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('SSH-EC2(docker image float') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  sshagent(credentials: ['EC2GumiD201']) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "echo Hello"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io 'sudo docker pull $imagefename:latest'"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io 'sudo docker run -i -p 3000:3000 -d $imagefename:latest'"

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

Â  Â  post {

Â  Â  Â  Â  always {

Â  Â  Â  Â  Â  Â  echo "í•­ìƒ ì‹¤í–‰"

Â  Â  Â  Â  }

Â  Â  Â  Â  success {

Â  Â  Â  Â  Â  Â  echo "ì„±ê³µ"

Â  Â  Â  Â  }

Â  Â  Â  Â  failure {

Â  Â  Â  Â  Â  Â  echo "ì‹¤íŒ¨í–ˆì„ ê²½ìš°, í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹¤í–‰ë˜ê²Œ êµ¬í˜„í•  ì˜ˆì •"

Â  Â  Â  Â  }

Â  Â  }

}

```


&nbsp;
  

**âœ” dockerfile**

  

```docker

FROM node:16-alpine as builder

  

# frontend docker containerì— spellit ë””ë ‰í„°ë¦¬ ìƒì„±

# RUN pwd

# RUN mkdir /spellit

  

# work dir ê³ ì •

WORKDIR /spellit

COPY package.json .

RUN npm install

COPY . .

  

# port 3000

EXPOSE 3000

CMD ["npm", "start"]

```

- nginx ê¸°ë°˜ì´ ì•„ë‹Œ, node ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ dockerfile

- ì´ì™€ ê°™ì´ í•  ê²½ìš°, ë°°í¬ íŒŒì¼ì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ, `npm start` â‡’ í˜„ì¬ í”„ë¡œì íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.


&nbsp;

### âœ **2-2 nginx ì ìš©í–ˆì„ ë•Œ, jenkins pipeline**

**âœ” frontend**

```bash

pipeline {

Â  Â  agent any

Â  Â  // node pluginìœ¼ë¡œ ì„¤ì¹˜ í›„, ì„¤ì •ì—ì„œ ë²„ì „ ë§ì¶°ì¤€ ê²ƒì„ ì“´ë‹¤.

Â  Â  tools {nodejs "Node16_14_2"}

  

Â  Â  environment{

Â  Â  Â  Â  imagefename = "d201ssafy/d201_fe"

Â  Â  Â  Â  registryCredential = "DockerHub_IdPwd"

Â  Â  Â  Â  dockerImage = ""

Â  Â  }

Â  Â  stages {

Â  Â  Â  Â  stage('GitLab Clone') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  checkout scmGit(branches: [[name: '*/fe']], extensions: [submodule(parentCredentials: true, reference: '', trackingSubmodules: true)], userRemoteConfigs: [[credentialsId: 'D201GitLab_IdPwd', url: 'https://lab.ssafy.com/s08-ai-speech-sub2/S08P22D201']])

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Frontend-Build') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  dir('spellit') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "ls -al"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // node, npm ì²« ì„¤ì¹˜í•  ë•Œ

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh """

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if ! test npm;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  then

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "ì„¤ì¹˜"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  curl -sL https://deb.nodesource.com/setup_16.x -o /tmp/nodesource_setup.sh

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bash /tmp/nodesource_setup.sh

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  apt install nodejs

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  apt install npm

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo "ì„¤ì¹˜ ë˜ì–´ ìˆë‹¤."

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fi

  

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  npm install serve

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  CI=false npm run build

  

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  """

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CI ë¸”ë¡œê·¸ : https://merrily-code.tistory.com/123

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  // Â  Â  stage('Docker before pull image stop'){

Â  Â  // Â  Â  Â  Â  steps {

Â  Â  // Â  Â  Â  Â  Â  Â  sshagent(credentials: ['EC2GumiD201']) {

Â  Â  // Â  Â  Â  Â  Â  Â  Â  Â  echo "ì‹œì‘"

Â  Â  // Â  Â  Â  Â  Â  Â  Â  Â  sh '''

Â  Â  // Â  Â  Â  Â  Â  Â  Â  Â  if test "`docker ps -aq --filter ancestor=d201ssafy/d201_fe:latest`"; then

Â  Â  Â  Â  Â  Â  Â  Â  // Â ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker stop $(docker ps -aq --filter ancestor=d201ssafy/d201_fe:latest)"

Â  Â  // Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker rm -f $(docker ps -aq --filter ancestor=d201ssafy/d201_fe:latest)"

Â  Â  // Â  Â  Â  Â  Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io "sudo docker rmi d201ssafy/d201_fe:latest"

Â  Â  // Â  Â  Â  Â  Â  Â  Â  Â  fi

Â  Â  // Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  // Â  Â  Â  Â  Â  Â  }

Â  Â  // Â  Â  Â  Â  }

Â  Â  // Â  Â  }

Â  Â  Â  Â  stage('Docker-Build (frontend)') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  dir('spellit'){

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ê°œì¸ì ìœ¼ë¡œ jenkins containerì— ì ‘ì†í•´, docker ì„¤ì¹˜(ê´€ë ¨ ëª…ë ¹ì–´ëŠ” ë¸”ë¡œê·¸ ì°¸ê³ )

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // https://kanoos-stu.tistory.com/m/53

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // tagë¥¼ ë¶™ì—¬ ë²„ì „ ë³„ë¡œ ë‚˜ëˆˆë‹¤.

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImage = docker.build imagefename + ":$BUILD_NUMBER"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker-Push (frontend)') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  script {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  docker.withRegistry('', registryCredential){

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImage.push()

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dockerImage.push("latest")

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('Docker new image remove') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  // docker hubì— push ë˜ì—ˆê¸°ì— ì‚­ì œí•œë‹¤.

Â  Â  Â  Â  Â  Â  Â  Â  sh "docker rmi $imagefename:$BUILD_NUMBER"

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  stage('ssh credential (blue, green)') {

Â  Â  Â  Â  Â  Â  steps {

Â  Â  Â  Â  Â  Â  Â  Â  sshagent(credentials: ['EC2GumiD201']) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // sh "ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io 'sudo docker pull $imagebename:latest'"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // sh "ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io 'sudo docker run -i -p 8000:8080 $imagebename:latest'"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sh "ssh -o StrictHostKeyChecking=no ubuntu@j8d201.p.ssafy.io 'cd /home/ubuntu/compose/frontend && ./deployfrontend.sh'"

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  }

Â  Â  post {

Â  Â  Â  Â  always {

Â  Â  Â  Â  Â  Â  echo "í•­ìƒ ì‹¤í–‰"

Â  Â  Â  Â  Â  Â  sh "docker image prune -f"

Â  Â  Â  Â  }

Â  Â  Â  Â  success {

Â  Â  Â  Â  Â  Â  echo "ì„±ê³µ"

Â  Â  Â  Â  }

Â  Â  Â  Â  failure {

Â  Â  Â  Â  Â  Â  echo "ì‹¤íŒ¨í–ˆì„ ê²½ìš°, í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹¤í–‰ë˜ê²Œ êµ¬í˜„í•  ì˜ˆì •"

Â  Â  Â  Â  }

Â  Â  }

}

```


&nbsp;

`Dockerfile`

```docker

FROM nginx

  

RUN mkdir /spellit

  

WORKDIR /spellit

  

RUN mkdir ./build

  

# spellitì— ìˆëŠ” build ë°°í¬íŒŒì¼ì„ ìƒì„±í•œ imageì˜ build ë””ë ‰í„°ë¦¬ë¡œ ë³µì‚¬

COPY ./build ./build

  

# nginx ì˜ default.conf ë¥¼ ì‚­ì œ

RUN rm /etc/nginx/conf.d/default.conf

  

# git nginx.conf ë¥¼ ì•„ë˜ ê²½ë¡œì— ë³µì‚¬

COPY ./nginx/spellit.conf /etc/nginx/conf.d

  

EXPOSE 3000

  

CMD ["nginx", "-g", "daemon off;"]

```

&nbsp;

&nbsp;
  

# âœ 4. flask ë°°í¬

  

**âœ” version**

  

```

Package Â  Â  Â  Â  Â  Â  Â Version

-------------------- ---------

aniso8601 Â  Â  Â  Â  Â  Â 9.0.1

asttokens Â  Â  Â  Â  Â  Â 2.2.1

attrs Â  Â  Â  Â  Â  Â  Â  Â 22.2.0

audioread Â  Â  Â  Â  Â  Â 3.0.0

backcall Â  Â  Â  Â  Â  Â  0.2.0

certifi Â  Â  Â  Â  Â  Â  Â 2022.12.7

cffi Â  Â  Â  Â  Â  Â  Â  Â  1.15.1

charset-normalizer Â  3.1.0

click Â  Â  Â  Â  Â  Â  Â  Â 8.1.3

colorama Â  Â  Â  Â  Â  Â  0.4.6

comm Â  Â  Â  Â  Â  Â  Â  Â  0.1.2

contourpy Â  Â  Â  Â  Â  Â 1.0.7

cycler Â  Â  Â  Â  Â  Â  Â  0.11.0

debugpy Â  Â  Â  Â  Â  Â  Â 1.6.6

decorator Â  Â  Â  Â  Â  Â 5.1.1

distlib Â  Â  Â  Â  Â  Â  Â 0.3.6

executing Â  Â  Â  Â  Â  Â 1.2.0

ffmpeg Â  Â  Â  Â  Â  Â  Â  1.4

filelock Â  Â  Â  Â  Â  Â  3.10.3

Flask Â  Â  Â  Â  Â  Â  Â  Â 2.2.3

Flask-Cors Â  Â  Â  Â  Â  3.0.10

flask-restx Â  Â  Â  Â  Â 1.1.0

fonttools Â  Â  Â  Â  Â  Â 4.39.0

gTTS Â  Â  Â  Â  Â  Â  Â  Â  2.3.1

idna Â  Â  Â  Â  Â  Â  Â  Â  3.4

importlib-metadata Â  6.0.0

importlib-resources Â 5.12.0

imutils Â  Â  Â  Â  Â  Â  Â 0.5.4

ipykernel Â  Â  Â  Â  Â  Â 6.21.3

ipython Â  Â  Â  Â  Â  Â  Â 8.11.0

itsdangerous Â  Â  Â  Â  2.1.2

jedi Â  Â  Â  Â  Â  Â  Â  Â  0.18.2

Jinja2 Â  Â  Â  Â  Â  Â  Â  3.1.2

joblib Â  Â  Â  Â  Â  Â  Â  1.2.0

jsonschema Â  Â  Â  Â  Â  4.17.3

jupyter_client Â  Â  Â  8.0.3

jupyter_core Â  Â  Â  Â  5.2.0

kiwisolver Â  Â  Â  Â  Â  1.4.4

lazy_loader Â  Â  Â  Â  Â 0.1

librosa Â  Â  Â  Â  Â  Â  Â 0.10.0

llvmlite Â  Â  Â  Â  Â  Â  0.39.1

MarkupSafe Â  Â  Â  Â  Â  2.1.2

matplotlib Â  Â  Â  Â  Â  3.3.4

matplotlib-inline Â  Â 0.1.6

mpmath Â  Â  Â  Â  Â  Â  Â  1.3.0

msgpack Â  Â  Â  Â  Â  Â  Â 1.0.5

nest-asyncio Â  Â  Â  Â  1.5.6

networkx Â  Â  Â  Â  Â  Â  3.0

numba Â  Â  Â  Â  Â  Â  Â  Â 0.56.4

numpy Â  Â  Â  Â  Â  Â  Â  Â 1.23.5

opencv-python Â  Â  Â  Â 4.7.0.72

packaging Â  Â  Â  Â  Â  Â 23.0

pandas Â  Â  Â  Â  Â  Â  Â  1.5.3

parso Â  Â  Â  Â  Â  Â  Â  Â 0.8.3

pickleshare Â  Â  Â  Â  Â 0.7.5

Pillow Â  Â  Â  Â  Â  Â  Â  9.4.0

pip Â  Â  Â  Â  Â  Â  Â  Â  Â 23.0.1

pkgutil_resolve_name 1.3.10

platformdirs Â  Â  Â  Â  3.1.1

playsound Â  Â  Â  Â  Â  Â 1.3.0

pooch Â  Â  Â  Â  Â  Â  Â  Â 1.7.0

prompt-toolkit Â  Â  Â  3.0.38

psutil Â  Â  Â  Â  Â  Â  Â  5.9.4

pure-eval Â  Â  Â  Â  Â  Â 0.2.2

py-hanspell Â  Â  Â  Â  Â 1.1

PyAudio Â  Â  Â  Â  Â  Â  Â 0.2.13

pycparser Â  Â  Â  Â  Â  Â 2.21

pydub Â  Â  Â  Â  Â  Â  Â  Â 0.25.1

Pygments Â  Â  Â  Â  Â  Â  2.14.0

pyparsing Â  Â  Â  Â  Â  Â 3.0.9

pyrsistent Â  Â  Â  Â  Â  0.19.3

python-dateutil Â  Â  Â 2.8.2

pytz Â  Â  Â  Â  Â  Â  Â  Â  2022.7.1

pywin32 Â  Â  Â  Â  Â  Â  Â 305

pyzmq Â  Â  Â  Â  Â  Â  Â  Â 25.0.0

requests Â  Â  Â  Â  Â  Â  2.28.2

resampy Â  Â  Â  Â  Â  Â  Â 0.4.2

scikit-learn Â  Â  Â  Â  1.2.2

scipy Â  Â  Â  Â  Â  Â  Â  Â 1.10.1

setuptools Â  Â  Â  Â  Â  49.2.1

six Â  Â  Â  Â  Â  Â  Â  Â  Â 1.16.0

sklearn Â  Â  Â  Â  Â  Â  Â 0.0.post1

soundfile Â  Â  Â  Â  Â  Â 0.12.1

soxr Â  Â  Â  Â  Â  Â  Â  Â  0.3.4

SpeechRecognition Â  Â 3.9.0

stack-data Â  Â  Â  Â  Â  0.6.2

sympy Â  Â  Â  Â  Â  Â  Â  Â 1.11.1

threadpoolctl Â  Â  Â  Â 3.1.0

torch Â  Â  Â  Â  Â  Â  Â  Â 1.9.0

torchvision Â  Â  Â  Â  Â 0.10.0

tornado Â  Â  Â  Â  Â  Â  Â 6.2

tqdm Â  Â  Â  Â  Â  Â  Â  Â  4.65.0

traitlets Â  Â  Â  Â  Â  Â 5.9.0

typing_extensions Â  Â 4.5.0

urllib3 Â  Â  Â  Â  Â  Â  Â 1.26.15

virtualenv Â  Â  Â  Â  Â  20.21.0

Wave Â  Â  Â  Â  Â  Â  Â  Â  0.0.2

wcwidth Â  Â  Â  Â  Â  Â  Â 0.2.6

Werkzeug Â  Â  Â  Â  Â  Â  2.2.3

wincertstore Â  Â  Â  Â  0.2

zipp Â  Â  Â  Â  Â  Â  Â  Â  3.15.0

```


&nbsp;

**âœ” Dockerfile**

  

```bash

FROM python:3.8.16

  

# project directory ìƒì„±

#WORKDIR /er

COPY . .

  

# ì´ê²ƒ ì•ˆí•˜ë©´ portaudio ì„¤ì¹˜ ì•ˆëœë‹¤.

RUN echo "Acquire::Check-Valid-Until \"false\";\nAcquire::Check-Date \"false\";" | cat > /etc/apt/apt.conf.d/10no--check-valid-until

RUN apt-get update

RUN apt -y install ffmpeg

# RUN apt-get -y upgrade

  

# ì´ê²ƒ ì•ˆí•˜ë©´ portaudio ì„¤ì¹˜ ì•ˆëœë‹¤.

RUN apt-get install -y portaudio19-dev

RUN pip install pip==23.0.1

# RUN pip install scikit-learn

RUN pip install -r requirements2.txt

  

# port 5000ë²ˆ

EXPOSE 5000

  

CMD ["python", "app.py"]

```

&nbsp;
  

**âœ” flask í”„ë¡œì íŠ¸**

  

(1) í˜„ì¬ projectë¥¼ ê¸°ë°˜ìœ¼ë¡œ docker imageë¥¼ ë§Œë“ ë‹¤.

  

(2) projectë¥¼ ê¸°ë°˜ìœ¼ë¡œ docker pushë¥¼ í•œë‹¤.

  

```bash

docker build -t d201ssafy/erflask:latest .

```

  

```bash

docker push d201ssafy/erflask:latest

```


&nbsp;

**âœ” ec2 ê°€ìƒì„œë²„ (image pull ë°›ê³ )**

  

```bash

docker run -p 5000:5000 --name erflask -d d201ssafy/erflask:latest

```

  

ì‹¤í–‰í•œë‹¤.


&nbsp;


**âœ” ì´ì™¸**  

conda ê°€ìƒí™˜ê²½ ë§Œë“¤ê¸° : **`conda create -n ê°€ìƒí™˜ê²½ ì´ë¦„ python = íŒŒì´ì¬ ë²„ì „`**

conda ê°€ìƒí™˜ê²½ ì ‘ê·¼í•˜ê¸° : `conda activate ê°€ìƒí™˜ê²½ ì´ë¦„`

conda ê°€ìƒí™˜ê²½ ì¡°íšŒí•˜ê¸° : `conda info â€”env`


&nbsp;


&nbsp;